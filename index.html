<!DOCTYPE html>

<div id="control-bar-container">
    <label>
        Nb rows
        <input name="nbRows" type="number"  onChange="handleOnChangeNbRows(this.value)"/>
    </label>

    <label>
        Nb columns
        <input name="nbCols" type="number" onChange="handleOnChangeNbCols(this.value)"/>
    </label>
    <button type="submit" onClick="handleOnClickGenerate()">Generate</button>
</div>

<div id="container"></div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script type="text/javascript" src="./utils/helper.js"></script>
<script>
  const transitionDuration=2000;
  let nbCols=4;
  let nbRows=4;
  let genData = genGridData(nbRows, nbCols);
  function handleOnClickGenerate(){
    genData = genGridData(nbRows,nbCols);
    renderMatrix(genData);
  }
  function handleOnChangeNbRows(val){
    nbRows=val;
  }
  function handleOnChangeNbCols(val){
    nbCols=val;
  }
  function handleOnClickCell(cellData){
    genData=genData.map(item=>{
      if (item.index===cellData.index){
        return {...cellData,selected:!cellData.selected};
      }else{
        return item;
      }
    })
    renderMatrix(genData);
  }

  const viewSize = {width: 640, height: 640};
  const margin = {top: 100, right: 5, bottom: 5, left: 100};
  const marginLabelsToMatrix=5;
  let matSvg;
  let matSvgG;
  const cellSize= 34;
  const radius = cellSize / 2;


// create the svg size by reducing the margin
const width = viewSize.width - margin.left - margin.right;
const height = viewSize.height - margin.top - margin.bottom;

matSvg=d3.create("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
;
matSvgG = matSvg.append("g")
    .attr("class","matSvgG")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
;
function removeMatrix(){
  matSvgG.selectAll('*').remove();
}

function renderMatrix(genData){
  // add d3 code here
  // build the size scale
  const minNbProductSold = d3.min(genData.map(cellData=>cellData.nbProductSold));
  const maxNbProductSold = d3.max(genData.map(cellData=>cellData.nbProductSold));
  const cellSizeScale = d3.scaleLinear()
    .domain([minNbProductSold, maxNbProductSold])
    .range([2, radius-1])
  ;
  // build the color scale
  const colorScheme = d3.schemeYlGnBu[9];
  const cellColorScale = d3.scaleQuantile()
    .domain(genData.map(cellData=>cellData.salesGrowth))
    .range(colorScheme)
  ;
  function updateCells(selection){
    selection.transition()
      .duration(transitionDuration)
      .attr("transform",(cellData)=>{
            return "translate("+(cellData.colPos*cellSize)+","+(cellData.rowPos*cellSize)+")"
          })
    ;
    selection.select(".CellCircle")
      .transition()
      .duration(transitionDuration)
      .attr("r",(cellData)=>cellSizeScale(cellData.nbProductSold))
      .attr("fill",(cellData) =>{
        const color = cellColorScale(cellData.salesGrowth);
        return color;
      })
      .attr("stroke-width",(cellData)=>{
        return cellData.selected?2:0;
      })
    ;
  }
  const cellG = matSvgG.selectAll(".cellG")
    // all elements with the class .cellG (empty the first time)
    .data(genData,(cellData)=>cellData.index)
    .join(
      enter=>{
        // all data items to add:
        // doesnâ€™exist in the select but exist in the new array
        const cellG=enter.append("g")
          .attr("class","cellG")
          .on("click", (event,cellData)=>{
            handleOnClickCell(cellData);
          })
        ;
          // render rect as child of each element "g"
        cellG.append("rect")
          .attr("class","CellRect")
          .attr("width",cellSize-1)
          .attr("height",cellSize-1)
          .attr("fill","lightGray")
        ;
        // render circle as child of each element "g"
        cellG.append("circle")
          .attr("class","CellCircle")
          .attr("cx",radius)
          .attr("cy",radius)
          .attr("stroke","red")
        ;
        updateCells(cellG);
      },
      update=>{
        updateCells(update);
      },
      exit =>{
        exit.select(".CellRect")
            .transition()
            .duration(transitionDuration)
            .attr("width",0)
            .attr("height",0)
        ;
        exit.select(".CellCircle")
            .transition()
            .duration(transitionDuration)
            .attr("cx",0)
            .attr("cy",0)
            .attr("r",0)
        ;
        exit.transition()
            .duration(transitionDuration)
            .attr("transform","translate("+width+","+height+")")
            .remove()
        ;
      }

    )
}
renderMatrix(genData);

container.append(matSvg.node())
</script>